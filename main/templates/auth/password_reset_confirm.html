{% extends 'base.html' %}

{% block title %}Yeni Åifre Belirle - Made in Izmir{% endblock %}

{% block body_class %}auth-page{% endblock %}

{% block content %}
<div class="login-container">
    <div class="auth-card">
        {% if validlink %}
        <div style="text-align:center; font-size:2.5rem; margin-bottom:0.5rem;">ğŸ”’</div>
        <h2>Yeni Åifre Belirle</h2>
        <p class="auth-subtitle">GÃ¼Ã§lÃ¼ bir ÅŸifre seÃ§in. En az 8 karakter, bÃ¼yÃ¼k/kÃ¼Ã§Ã¼k harf, rakam ve Ã¶zel karakter iÃ§ermelidir.</p>

        {% if form.non_field_errors %}
        <div class="non-field-error">{{ form.non_field_errors.0 }}</div>
        {% endif %}

        <form method="post" id="confirmForm" novalidate>
            {% csrf_token %}

            <div class="form-group">
                <label for="id_new_password1">
                    Yeni Åifre <span class="required">*</span>
                </label>
                <div class="input-wrapper">
                    <input type="password"
                           name="new_password1"
                           id="id_new_password1"
                           class="form-control{% if form.new_password1.errors %} is-invalid{% endif %}"
                           autocomplete="new-password"
                           autofocus
                           required>
                    <button type="button" class="btn-eye" id="togglePwd1" tabindex="-1" aria-label="Åifreyi gÃ¶ster">ğŸ‘</button>
                </div>
                {% if form.new_password1.errors %}
                <div class="error-message">{{ form.new_password1.errors.0 }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="id_new_password2">
                    Yeni Åifre (Tekrar) <span class="required">*</span>
                </label>
                <div class="input-wrapper">
                    <input type="password"
                           name="new_password2"
                           id="id_new_password2"
                           class="form-control{% if form.new_password2.errors %} is-invalid{% endif %}"
                           autocomplete="new-password"
                           required>
                    <button type="button" class="btn-eye" id="togglePwd2" tabindex="-1" aria-label="Åifreyi gÃ¶ster">ğŸ‘</button>
                </div>
                {% if form.new_password2.errors %}
                <div class="error-message">{{ form.new_password2.errors.0 }}</div>
                {% endif %}
                <div id="pwdMatchHint" style="margin-top:0.35rem; font-size:0.78rem; font-weight:600; display:none;"></div>
            </div>

            <button type="submit" class="btn-auth" id="confirmBtn">Åifremi GÃ¼ncelle</button>
        </form>

        {% else %}
        <div style="text-align:center; font-size:2.5rem; margin-bottom:0.75rem;">âš ï¸</div>
        <h2>BaÄŸlantÄ± GeÃ§ersiz</h2>
        <div class="alert alert-error" style="margin-top:1rem;">
            Bu ÅŸifre sÄ±fÄ±rlama baÄŸlantÄ±sÄ± geÃ§ersiz ya da sÃ¼resi dolmuÅŸ. LÃ¼tfen yeni bir baÄŸlantÄ± talep edin.
        </div>
        <a href="{% url 'password_reset' %}" class="btn-auth" style="display:block; text-align:center; text-decoration:none; margin-top:1rem;">
            Yeni BaÄŸlantÄ± Ä°ste
        </a>
        {% endif %}

        <div class="link-text">
            <a href="{% url 'main:login' %}">â† GiriÅŸ SayfasÄ±na DÃ¶n</a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    function makeEyeToggle(btnId, inputId) {
        const btn = document.getElementById(btnId);
        const inp = document.getElementById(inputId);
        if (!btn || !inp) return;
        btn.addEventListener('click', function () {
            const show = inp.type === 'password';
            inp.type = show ? 'text' : 'password';
            this.textContent = show ? 'ğŸ™ˆ' : 'ğŸ‘';
        });
    }
    makeEyeToggle('togglePwd1', 'id_new_password1');
    makeEyeToggle('togglePwd2', 'id_new_password2');

    // Live match hint
    const p1 = document.getElementById('id_new_password1');
    const p2 = document.getElementById('id_new_password2');
    const hint = document.getElementById('pwdMatchHint');
    if (p1 && p2 && hint) {
        function updateMatch() {
            if (!p2.value) { hint.style.display = 'none'; return; }
            hint.style.display = 'block';
            if (p1.value === p2.value) {
                hint.textContent = 'Åifreler uyuÅŸuyor. âœ“';
                hint.style.color = '#22c55e';
            } else {
                hint.textContent = 'Åifreler uyuÅŸmuyor.';
                hint.style.color = '#ef4444';
            }
        }
        p1.addEventListener('input', updateMatch);
        p2.addEventListener('input', updateMatch);
    }

    // Loading state
    const form = document.getElementById('confirmForm');
    const btn  = document.getElementById('confirmBtn');
    if (form && btn) {
        form.addEventListener('submit', function () {
            btn.classList.add('loading');
            btn.disabled = true;
        });
    }

    // Scroll to error
    const firstErr = document.querySelector('.error-message, .non-field-error, .is-invalid');
    if (firstErr) firstErr.scrollIntoView({ behavior: 'smooth', block: 'center' });
});
</script>
{% endblock %}
