{% extends 'base.html' %}

{% block title %}KayÄ±t Ol - Made in Izmir{% endblock %}

{% block body_class %}auth-page{% endblock %}
{% block extra_css %}
<link href="https://unpkg.com/slim-select@2.8.2/dist/slimselect.css" rel="stylesheet">
<style>
    .ss-main {
        padding: 0.5rem;
        border-radius: var(--radius-md);
        border-color: #cbd5e1;
        background-color: #f8fafc;
    }

    .ss-main:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="signup-container">
    <div class="auth-card">
        <h2 data-i18n="signup.title">KayÄ±t Ol</h2>

        {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
        {% endif %}

        <form method="post" id="signupForm">
            {% csrf_token %}

            <!-- Personal Information -->
            <div class="form-section">
                <h3 data-i18n="signup.personal_info">KiÅŸisel Bilgiler</h3>

                <div class="form-group">
                    <label for="{{ form.first_name.id_for_label }}">
                        <span data-i18n="signup.first_name">Ad</span> <span class="required">*</span>
                    </label>
                    {{ form.first_name }}
                    {% if form.first_name.errors %}
                    <div class="error-message">{{ form.first_name.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.last_name.id_for_label }}">
                        <span data-i18n="signup.last_name">Soyad</span> <span class="required">*</span>
                    </label>
                    {{ form.last_name }}
                    {% if form.last_name.errors %}
                    <div class="error-message">{{ form.last_name.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.email.id_for_label }}">
                        <span data-i18n="signup.email">E-posta</span> <span class="required">*</span>
                    </label>
                    {{ form.email }}
                    {% if form.email.errors %}
                    <div class="error-message">{{ form.email.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.username.id_for_label }}">
                        <span data-i18n="signup.username">KullanÄ±cÄ± AdÄ±</span> <span class="required">*</span>
                    </label>
                    {{ form.username }}
                    {% if form.username.errors %}
                    <div class="error-message">{{ form.username.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.password1.id_for_label }}">
                        <span data-i18n="signup.password">Åžifre</span> <span class="required">*</span>
                    </label>
                    {{ form.password1 }}
                    {% if form.password1.errors %}
                    <div class="error-message">{{ form.password1.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.password2.id_for_label }}">
                        <span data-i18n="signup.password_confirm">Åžifre Tekrar</span> <span class="required">*</span>
                    </label>
                    {{ form.password2 }}
                    {% if form.password2.errors %}
                    <div class="error-message">{{ form.password2.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <!-- Company Information -->
            <div class="form-section">
                <h3 data-i18n="signup.company_info">Firma Bilgileri</h3>

                <div class="form-group">
                    <label for="{{ form.company_name.id_for_label }}">
                        <span data-i18n="signup.company_name">Firma AdÄ±</span> <span class="required">*</span>
                    </label>
                    {{ form.company_name }}
                    {% if form.company_name.errors %}
                    <div class="error-message">{{ form.company_name.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.phone_number.id_for_label }}">
                        <span data-i18n="signup.phone_number">Telefon NumarasÄ±</span> <span class="required">*</span>
                    </label>
                    {{ form.phone_number }}
                    {% if form.phone_number.errors %}
                    <div class="error-message">{{ form.phone_number.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.country.id_for_label }}">
                        <span data-i18n="signup.country">Ãœlke</span> <span class="required">*</span>
                    </label>
                    {{ form.country }}
                    {% if form.country.errors %}
                    <div class="error-message">{{ form.country.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.city.id_for_label }}">
                        <span data-i18n="signup.city">Åžehir</span> <span class="required">*</span>
                    </label>
                    {{ form.city }}
                    {% if form.city.errors %}
                    <div class="error-message">{{ form.city.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <!-- User Type -->
            <div class="form-section">
                <h3 data-i18n="signup.user_type">KullanÄ±cÄ± Tipi</h3>
                <p style="margin-bottom: 1rem; color: #666;" data-i18n="signup.user_type_desc">
                    En az bir seÃ§enek seÃ§melisiniz. Her iki seÃ§eneÄŸi de seÃ§ebilirsiniz.
                </p>

                <div class="form-check user-type-box">
                    {{ form.is_buyer }}
                    <label class="form-check-label" for="{{ form.is_buyer.id_for_label }}">
                        <strong data-i18n="signup.buyer">AlÄ±cÄ±</strong>
                    </label>
                </div>

                <div class="form-check user-type-box">
                    {{ form.is_producer }}
                    <label class="form-check-label" for="{{ form.is_producer.id_for_label }}">
                        <strong data-i18n="signup.producer">Ãœretici</strong>
                    </label>
                </div>

                {% if form.non_field_errors %}
                <div class="error-message">{{ form.non_field_errors.0 }}</div>
                {% endif %}
            </div>

            <!-- Buyer-specific fields -->
            <div id="buyerFields" class="conditional-fields">
                <h4 style="margin-bottom: 1rem;" data-i18n="signup.buyer_info">AlÄ±cÄ± Bilgileri</h4>

                <div class="form-group">
                    <label for="{{ form.buyer_interested_sectors.id_for_label }}">
                        <span data-i18n="signup.buyer_sectors">Ä°lgilenilen SektÃ¶rler</span> <span
                            class="required">*</span>
                    </label>
                    {{ form.buyer_interested_sectors }}
                    <small style="color: #666;" data-i18n="signup.buyer_sectors_help">VirgÃ¼lle ayÄ±rarak yazÄ±n (Ã¶rn:
                        Tekstil, GÄ±da, Mermer)</small>
                    {% if form.buyer_interested_sectors.errors %}
                    <div class="error-message">{{ form.buyer_interested_sectors.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.buyer_quarterly_volume.id_for_label }}">
                        <span data-i18n="signup.buyer_volume">Ã‡eyreklik AlÄ±m Hacmi (USD)</span> <span
                            class="required">*</span>
                    </label>
                    {{ form.buyer_quarterly_volume }}
                    {% if form.buyer_quarterly_volume.errors %}
                    <div class="error-message">{{ form.buyer_quarterly_volume.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <!-- Producer-specific fields -->
            <div id="producerFields" class="conditional-fields">
                <h4 style="margin-bottom: 1rem;" data-i18n="signup.producer_info">Ãœretici Bilgileri</h4>

                <div class="form-group">
                    <label for="{{ form.producer_sectors.id_for_label }}">
                        <span data-i18n="signup.producer_sector">SektÃ¶rler</span> <span class="required">*</span>
                    </label>
                    {{ form.producer_sectors }}
                    {% if form.producer_sectors.errors %}
                    <div class="error-message">{{ form.producer_sectors.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.producer_quarterly_sales.id_for_label }}">
                        <span data-i18n="signup.producer_sales">Ã‡eyreklik SatÄ±ÅŸ Hacmi (USD)</span> <span
                            class="required">*</span>
                    </label>
                    {{ form.producer_quarterly_sales }}
                    {% if form.producer_quarterly_sales.errors %}
                    <div class="error-message">{{ form.producer_quarterly_sales.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.producer_product_count.id_for_label }}">
                        <span data-i18n="signup.producer_products">YaklaÅŸÄ±k ÃœrÃ¼n SayÄ±sÄ±</span> <span
                            class="required">*</span>
                    </label>
                    {{ form.producer_product_count }}
                    {% if form.producer_product_count.errors %}
                    <div class="error-message">{{ form.producer_product_count.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            {% if consent_text %}
            {{ consent_text.text_tr|json_script:"consent-text-tr" }}
            {{ consent_text.text_en|json_script:"consent-text-en" }}
            {% endif %}

            <!-- Mandatory membership consent checkbox -->
            <div class="consent-checkbox-wrapper" id="consentSection">
                <label class="consent-label" for="membership_consent">
                    <input type="checkbox" name="membership_consent" id="membership_consent">
                    <span class="consent-checkbox-text">
                        {% if consent_text %}
                            <span id="consentPreview">{{ consent_text.text_tr|truncatewords:40 }}</span>
                            <span id="consentFull" style="display:none;">{{ consent_text.text_tr|linebreaksbr }}</span>
                            <a href="#" id="consentToggleLink" class="consent-toggle-link" onclick="toggleConsentText(event)">DevamÄ±nÄ± GÃ¶r â–¾</a>
                        {% else %}
                            Ãœyelik onay metnini okuyup kabul etmeniz gerekmektedir.
                        {% endif %}
                        <strong id="consentMandatoryLabel">Onay vermeden kayÄ±t tamamlanamaz.</strong>
                    </span>
                </label>
                <div class="consent-error" id="consentError" style="display:none;">
                    Devam etmek iÃ§in Ã¼yelik onay metnini kabul etmelisiniz.
                </div>
            </div>

            <button type="button" class="btn-auth" id="submitBtn" disabled onclick="openConsentPopup()" data-i18n="signup.submit">KayÄ±t Ol</button>

        </form>

        <div class="link-text">
            <span data-i18n="signup.have_account">Zaten hesabÄ±nÄ±z var mÄ±?</span>
            <a href="{% url 'main:login' %}" data-i18n="signup.login_link">GiriÅŸ YapÄ±n</a>
        </div>
    </div>
</div>

<!-- ===== Membership Consent Confirmation Popup ===== -->
<div id="consentModal" role="dialog" aria-modal="true" aria-labelledby="consentModalTitle">
    <div class="consent-modal-box">
        <div class="consent-modal-header">
            <span class="lock-icon">ðŸ”’</span>
            <h3 id="consentModalTitle" data-i18n="signup.consent_title">Ãœyelik Onay Metni â€“ Son Onay</h3>
        </div>
        <div class="consent-modal-body">
            {% if consent_text %}
                <span class="lang-badge tr">TR</span>
                <div class="consent-modal-text">{{ consent_text.text_tr|linebreaksbr }}</div>
                <span class="lang-badge en">EN</span>
                <div class="consent-modal-text">{{ consent_text.text_en|linebreaksbr }}</div>
            {% else %}
                <p>Onay metni yÃ¼klenemedi. LÃ¼tfen daha sonra tekrar deneyin.</p>
            {% endif %}
        </div>
        <div class="consent-modal-footer">
            <button type="button" class="btn-consent-cancel" onclick="closeConsentPopup()" data-i18n="signup.consent_cancel">VazgeÃ§</button>
            <button type="button" class="btn-consent-confirm" id="confirmAndRegisterBtn" onclick="confirmAndSubmit()" data-i18n="signup.consent_confirm">âœ“ OnaylÄ±yorum ve Ãœye Ol</button>
        </div>
    </div>
</div>

<style>
    /* Styling for the sector dropdowns */
    .sector-select {
        height: auto;
        min-height: 45px;
    }

    .user-type-box {
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }

    .user-type-box.selected-box {
        background: rgba(204, 164, 59, 0.1);
        border-color: var(--accent-color);
    }

    /* ===== Consent Checkbox ===== */
    .consent-checkbox-wrapper {
        margin-top: 1.5rem;
        margin-bottom: 1rem;
        padding: 1rem 1.2rem;
        background: rgba(204, 164, 59, 0.06);
        border: 1.5px solid rgba(204, 164, 59, 0.35);
        border-radius: var(--radius-md);
    }
    .consent-label {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        cursor: pointer;
    }
    .consent-label input[type="checkbox"] {
        margin-top: 3px;
        min-width: 18px;
        height: 18px;
        accent-color: var(--accent-color);
        cursor: pointer;
    }
    .consent-checkbox-text {
        font-size: 0.82rem;
        line-height: 1.55;
        color: var(--text-secondary, #64748b);
    }
    .consent-error {
        color: #e53e3e;
        font-size: 0.8rem;
        margin-top: 0.4rem;
    }
    #submitBtn:disabled {
        opacity: 0.45;
        cursor: not-allowed;
    }
    .consent-toggle-link {
        display: inline-block;
        margin-top: 0.35rem;
        font-size: 0.78rem;
        font-weight: 600;
        color: var(--accent-color, #cca43b);
        text-decoration: none;
        cursor: pointer;
        transition: opacity 0.2s;
    }
    .consent-toggle-link:hover { opacity: 0.75; }
    #consentFull {
        display: none;
        margin-top: 0.4rem;
        font-size: 0.82rem;
        line-height: 1.6;
        color: var(--text-secondary, #64748b);
        animation: fadeIn 0.25s ease;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* ===== Consent Popup Modal ===== */
    #consentModal {
        display: none;
        position: fixed;
        inset: 0;
        z-index: 9999;
        background: rgba(0,0,0,0.55);
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }
    #consentModal.open {
        display: flex;
    }
    .consent-modal-box {
        background: #fff;
        border-radius: 14px;
        max-width: 620px;
        width: 100%;
        box-shadow: 0 20px 60px rgba(0,0,0,0.25);
        overflow: hidden;
        animation: modalSlideIn 0.3s ease;
    }
    @keyframes modalSlideIn {
        from { transform: translateY(-30px); opacity: 0; }
        to   { transform: translateY(0);    opacity: 1; }
    }
    .consent-modal-header {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: #fff;
        padding: 1.25rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    .consent-modal-header h3 {
        margin: 0;
        font-size: 1.05rem;
        font-weight: 700;
        letter-spacing: 0.02em;
        color: #ffffff !important;
    }
    .consent-modal-header .lock-icon {
        font-size: 1.3rem;
        color: #ffffff !important;
    }
    .consent-modal-body {
        padding: 1.5rem;
        max-height: 55vh;
        overflow-y: auto;
    }
    .consent-modal-body p,
    .consent-modal-text {
        font-size: 0.84rem;
        line-height: 1.7;
        color: #334155;
        margin-bottom: 0.9rem;
    }
    .consent-modal-body .lang-badge {
        display: inline-block;
        font-size: 0.7rem;
        font-weight: 700;
        letter-spacing: 0.08em;
        padding: 2px 8px;
        border-radius: 20px;
        margin-bottom: 0.5rem;
    }
    .lang-badge.tr { background: #fef3c7; color: #92400e; }
    .lang-badge.en { background: #dbeafe; color: #1e40af; margin-top: 0.75rem; }
    .consent-modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid #e2e8f0;
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
        background: #f8fafc;
    }
    .btn-consent-cancel {
        padding: 0.6rem 1.3rem;
        border-radius: var(--radius-md);
        border: 1.5px solid #cbd5e1;
        background: transparent;
        color: #64748b;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-consent-cancel:hover { background: #f1f5f9; color: #1e293b; }
    .btn-consent-confirm {
        padding: 0.6rem 1.5rem;
        border-radius: var(--radius-md);
        border: none;
        background: linear-gradient(135deg, var(--accent-color, #cca43b) 0%, #a87d20 100%);
        color: #fff;
        font-weight: 700;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 2px 8px rgba(204,164,59,0.3);
    }
    .btn-consent-confirm:hover { transform: translateY(-1px); box-shadow: 0 4px 14px rgba(204,164,59,0.4); }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/slim-select@2.8.2/dist/slimselect.min.js"></script>
<script>
    // Show/hide conditional fields based on user type selection
    document.addEventListener('DOMContentLoaded', function () {
        const buyerCheckbox = document.getElementById('is_buyer');
        const producerCheckbox = document.getElementById('is_producer');
        const buyerFields = document.getElementById('buyerFields');
        const producerFields = document.getElementById('producerFields');

        // Initialize SlimSelect
        let buyerSlim, producerSlim;

        if (document.getElementById('id_buyer_interested_sectors')) {
            buyerSlim = new SlimSelect({
                select: '#id_buyer_interested_sectors',
                settings: {
                    placeholderText: 'SektÃ¶r SeÃ§iniz',
                }
            });
        }

        if (document.getElementById('id_producer_sectors')) {
            producerSlim = new SlimSelect({
                select: '#id_producer_sectors',
                settings: {
                    placeholderText: 'SektÃ¶r SeÃ§iniz',
                }
            });
        }

        function toggleFields() {
            const boxes = document.querySelectorAll('.user-type-box');

            if (buyerCheckbox.checked) {
                buyerFields.classList.add('active');
                buyerCheckbox.parentElement.classList.add('selected-box');
            } else {
                buyerFields.classList.remove('active');
                buyerCheckbox.parentElement.classList.remove('selected-box');
            }

            if (producerCheckbox.checked) {
                producerFields.classList.add('active');
                producerCheckbox.parentElement.classList.add('selected-box');
            } else {
                producerFields.classList.remove('active');
                producerCheckbox.parentElement.classList.remove('selected-box');
            }
        }

        // Make whole boxes clickable
        document.querySelectorAll('.user-type-box').forEach(box => {
            box.addEventListener('click', function (e) {
                // Don't trigger if clicking the actual checkbox or label (browser handles those)
                if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'LABEL' && e.target.tagName !== 'STRONG') {
                    const checkbox = this.querySelector('input[type="checkbox"]');
                    checkbox.checked = !checkbox.checked;
                    // Manually trigger change event to run toggleFields
                    checkbox.dispatchEvent(new Event('change'));
                }
            });
        });

        // Initial check
        toggleFields();

        // Add event listeners
        buyerCheckbox.addEventListener('change', toggleFields);
        producerCheckbox.addEventListener('change', toggleFields);

        // --- Sector Translation Logic ---
        function updateSectorLabels() {
            const currentLang = localStorage.getItem('madeInIzmirLang') || 'tr';
            const sectorOptions = document.querySelectorAll('.sector-select option');

            sectorOptions.forEach(opt => {
                const fullText = opt.getAttribute('data-full-text') || opt.textContent;
                if (!opt.getAttribute('data-full-text')) {
                    opt.setAttribute('data-full-text', fullText);
                }

                if (fullText.includes(' | ')) {
                    const parts = fullText.split(' | ');
                    opt.textContent = currentLang === 'tr' ? parts[0] : parts[1];
                }
            });

            // Update SlimSelect placeholders and re-render
            const placeholder = currentLang === 'tr' ? 'SektÃ¶r SeÃ§iniz' : 'Select Sectors';
            if (buyerSlim) {
                buyerSlim.setData(Array.from(document.querySelectorAll('#id_buyer_interested_sectors option')).map(opt => ({
                    text: opt.textContent,
                    value: opt.value,
                    selected: opt.selected
                })));
            }
            if (producerSlim) {
                producerSlim.setData(Array.from(document.querySelectorAll('#id_producer_sectors option')).map(opt => ({
                    text: opt.textContent,
                    value: opt.value,
                    selected: opt.selected
                })));
            }
        }

        // Initial update
        updateSectorLabels();

        // Listen for language changes (we'll hook into the lang buttons)
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Wait a tiny bit for localStorage to update
                setTimeout(() => {
                    updateSectorLabels();
                    updateConsentText();
                }, 50);
            });
        });

        // --- Consent Text Translation Logic ---
        function truncateWords(str, n) {
            const words = str.split(/\s+/);
            if (words.length <= n) return str;
            return words.slice(0, n).join(' ') + 'â€¦';
        }

        function updateConsentText() {
            const lang = localStorage.getItem('madeInIzmirLang') || 'tr';

            // Read texts from the safe json_script blocks Django rendered
            const trEl = document.getElementById('consent-text-tr');
            const enEl = document.getElementById('consent-text-en');
            if (!trEl || !enEl) return;

            const textTr = JSON.parse(trEl.textContent);
            const textEn = JSON.parse(enEl.textContent);
            const activeText = lang === 'en' ? textEn : textTr;
            if (!activeText) return;

            // Update preview (truncated)
            const preview = document.getElementById('consentPreview');
            if (preview) preview.textContent = truncateWords(activeText, 40);

            // Update full expanded text (convert \n to <br>)
            const full = document.getElementById('consentFull');
            if (full) full.innerHTML = activeText.replace(/\n/g, '<br>');

            // Translate toggle link label
            const link = document.getElementById('consentToggleLink');
            if (link) {
                const isExpanded = full && full.style.display !== 'none';
                if (lang === 'en') {
                    link.textContent = isExpanded ? 'Show Less â–´' : 'Read More â–¾';
                } else {
                    link.textContent = isExpanded ? 'Gizle â–´' : 'DevamÄ±nÄ± GÃ¶r â–¾';
                }
            }

            // Translate mandatory label
            const mandatory = document.getElementById('consentMandatoryLabel');
            if (mandatory) {
                mandatory.textContent = lang === 'en'
                    ? 'Consent is required to complete registration.'
                    : 'Onay vermeden kayÄ±t tamamlanamaz.';
            }

            // Translate inline error message
            const err = document.getElementById('consentError');
            if (err) {
                err.textContent = lang === 'en'
                    ? 'You must accept the membership consent to proceed.'
                    : 'Devam etmek iÃ§in Ã¼yelik onay metnini kabul etmelisiniz.';
            }
        }

        // Run on initial page load to match saved language
        updateConsentText();

        // ===== Consent Checkbox: enable/disable the submit button =====
        const consentCheckbox = document.getElementById('membership_consent');
        const submitBtn = document.getElementById('submitBtn');

        consentCheckbox.addEventListener('change', function () {
            submitBtn.disabled = !this.checked;
            document.getElementById('consentError').style.display = 'none';
        });
    });

    // ===== Consent Text Toggle (See More / Hide) =====
    function toggleConsentText(e) {
        e.preventDefault();
        e.stopPropagation(); // don't trigger the checkbox label
        const preview = document.getElementById('consentPreview');
        const full    = document.getElementById('consentFull');
        const link    = document.getElementById('consentToggleLink');
        const isExpanded = full.style.display !== 'none';
        if (isExpanded) {
            full.style.display = 'none';
            preview.style.display = '';
            link.textContent = 'DevamÄ±nÄ± GÃ¶r â–¾';
        } else {
            preview.style.display = 'none';
            full.style.display = 'block';
            link.textContent = 'Gizle â–´';
        }
    }

    // ===== Consent Popup Functions =====
    function openConsentPopup() {
        const consentCheckbox = document.getElementById('membership_consent');
        if (!consentCheckbox.checked) {
            document.getElementById('consentError').style.display = 'block';
            return;
        }
        document.getElementById('consentModal').classList.add('open');
        document.body.style.overflow = 'hidden';
    }

    function closeConsentPopup() {
        document.getElementById('consentModal').classList.remove('open');
        document.body.style.overflow = '';
    }

    function confirmAndSubmit() {
        // User confirmed in the popup â€“ submit the actual form
        closeConsentPopup();
        const form = document.getElementById('signupForm');
        // Change button to loading state
        const btn = document.getElementById('confirmAndRegisterBtn');
        if (btn) { btn.textContent = 'Kaydediliyorâ€¦'; btn.disabled = true; }
        form.submit();
    }

    // Close modal on backdrop click
    document.getElementById('consentModal').addEventListener('click', function (e) {
        if (e.target === this) { closeConsentPopup(); }
    });

    // Close modal on Escape key
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') { closeConsentPopup(); }
    });
</script>
{% endblock %}